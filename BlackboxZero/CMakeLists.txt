project(BlackboxZero)
message("Welcome to BlackBox!")
cmake_minimum_required(VERSION 2.8.9)
set(CMAKE_VERBOSE_MAKEFILE on)

# use this for develoment, if you do not pass it from command line:
set(CMAKE_INSTALL_PREFIX "c:/bbLean_devel")

message("bb generator=${CMAKE_GENERATOR}")
message("bb install path=${CMAKE_INSTALL_PREFIX}")

include(build/compiler.cmake)
include(ExternalProject)

# detect 32 / 64bit environment
if( CMAKE_SIZEOF_VOID_P EQUAL 8 )
	set(buildbits 64)
  message("bb build=64bit")
else( CMAKE_SIZEOF_VOID_P EQUAL 8 )
	set(buildbits 32)
  message("bb build=32bit")
endif( CMAKE_SIZEOF_VOID_P EQUAL 8 )

# font tools and conversion
add_subdirectory(build/bdf2fon)
add_custom_target(fonts ALL)
set(FONTDIR "${CMAKE_SOURCE_DIR}/fonts/artwiz-latin1-1.0-src" CACHE STRING "font directory")
set(FONTOUTDIR "${CMAKE_BINARY_DIR}/converted_fonts" CACHE STRING "font directory")
set(BDF2FNT ${CMAKE_BINARY_DIR}/bdf2fnt.exe CACHE STRING "bdf2fnt path")
set(FNT2FON ${CMAKE_BINARY_DIR}/fnt2fon.exe CACHE STRING "fnt2fon path")
add_custom_command(TARGET fonts COMMAND ${CMAKE_COMMAND}
	 -DSOURCE_DIR=${CMAKE_CURRENT_SOURCE_DIR}
	 -DFONTDIR="${FONTDIR}"
	 -DBDF2FNT="${BDF2FNT}"
	 -DFNT2FON="${FNT2FON}"
	 -DFONTOUTDIR=${FONTOUTDIR}
	 ARGS -P ${CMAKE_SOURCE_DIR}/fonts/fonts.cmake)
install(DIRECTORY ${FONTOUTDIR} 
	DESTINATION .
	FILES_MATCHING PATTERN "*.fon"
	PERMISSIONS OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ)

# core modules
add_subdirectory(lib)
add_subdirectory(blackbox)
add_subdirectory(blackbox/Hooks)

# documentation
add_subdirectory(build/fuzzydoc)
#add_subdirectory(docs)

# plugins
add_subdirectory(3rd_party/iTunesCOMWindowsSDK)
add_subdirectory(3rd_party/foobar2000)
add_subdirectory(plugins/bbKeys)
add_subdirectory(plugins/bbPlugin)
add_subdirectory(plugins/bbLeanBar)
add_subdirectory(plugins/bbFoomp)
add_subdirectory(plugins/bbLeanSkin)
# 32b for 64b build
if( buildbits EQUAL 64 )
	if (MSVC)
		string(REGEX REPLACE " Win64" "" GENERATOR_FOR_32 ${CMAKE_GENERATOR})
	endif (MSVC)
	if (MINGW)
		# TODO
	endif (MINGW)
	message("bbLeanSkin on 64bit... 32bit generator=${GENERATOR_FOR_32}")

	set(bbLeanSkin_SOURCE_DIR  ${CMAKE_SOURCE_DIR}/plugins/bbLeanSkin)
  set(bbLeanSkinRun32_PATH ${bbLeanSkin_SOURCE_DIR}/bbLeanSkinRun32)
  message("bbLeanSkin on 64bit... path=${bbLeanSkinRun32_PATH}")
	ExternalProject_Add (
		bbLeanSkinRun32
		CMAKE_GENERATOR ${GENERATOR_FOR_32}
		CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CMAKE_INSTALL_PREFIX}
		SOURCE_DIR  ${bbLeanSkinRun32_PATH}
		DOWNLOAD_COMMAND ""
	)
	set_property(TARGET bbLeanSkinRun32 PROPERTY FOLDER "plugins/bbLeanSkin")
endif( buildbits EQUAL 64 )

add_subdirectory(plugins/bbSlit)
add_subdirectory(plugins/bbAnalog)
add_subdirectory(plugins/BBCalendar)
add_subdirectory(plugins/BB8Ball)
add_subdirectory(plugins/bbAnalogEx)
add_subdirectory(plugins/BBDigitalEx)
add_subdirectory(plugins/BBMagnify)
add_subdirectory(plugins/BBMessageBox)
add_subdirectory(plugins/BBRSS)
add_subdirectory(plugins/BBSysMeter)
add_subdirectory(plugins/BBXO)
add_subdirectory(plugins/bbIconBox)
add_subdirectory(plugins/bbColor3dc)
add_subdirectory(plugins/bbWorkspaceWheel)
add_subdirectory(plugins/bbPlugin+)
add_subdirectory(plugins/bbLeanBar+)
add_subdirectory(plugins/BBPager)
add_subdirectory(plugins/BBStyle)
add_subdirectory(plugins/bbRecycleBin)
add_subdirectory(plugins/bbInterface)
add_subdirectory(plugins/bbFooMan)
add_subdirectory(plugins/bbMuse)
add_subdirectory(plugins/bbPlayer)
add_subdirectory(plugins/bbSeekBar)
add_subdirectory(plugins/BBColorEx)
#add_subdirectory(plugins/bbLeanBar2)
#add_subdirectory(plugins/bbDesktop)
#add_subdirectory(plugins/bbIME)
#add_subdirectory(plugins/bbLua)
#add_subdirectory(plugins/bbSetCursors)
#add_subdirectory(plugins/bbTaskSwitch)

# NOTE: following plugins are not yet mingw compatible
if (NOT MINGW)
	add_subdirectory(plugins/bbInterface_iTunes)
endif (NOT MINGW)

# NOTE: mingw 64 bit does not work yet!
if (MSVC)
	add_subdirectory(plugins/bbSystemBarEx)
endif (MSVC)
if (MINGW)
	if (NOT ${buildbits} MATCHES "64")
		add_subdirectory(plugins/SystemBarEx)
	ENDIF()
endif (MINGW)

# tools
add_subdirectory(tools/bsetshell)
add_subdirectory(tools/bsetroot)
add_subdirectory(tools/bbstylemaker)
add_subdirectory(tools/bbnote)

# installation
function(install_if_absent)
	foreach(f ${ARGN})
		if(NOT EXISTS \"${CMAKE_INSTALL_PREFIX}/${f}\")
			install(FILES ${f} DESTINATION .)
		endif()
	endforeach()
endfunction()

set(main_CONFIGS
  config/menu.rc 
  config/blackbox.rc
  config/extensions.rc
  config/plugins.rc
  config/shellfolders.rc
  config/stickywindows.ini
)

install_if_absent(${main_CONFIGS})
install(DIRECTORY styles backgrounds DESTINATION .)

# not used (yet).. from old makefiles
set (CLEAN_FILES
  bbnote.ini
  docs/bbnote.*
  bbstylemaker.rc
  docs/bbstylemaker.txt
  docs/nls-c.txt
  bsetroot.rc
  docs/bsetroot.*
  docs/*.bmp
  *.exe *.dll
)



###############################################################################
# debug stuff
#message("Debug variable dump:")
#get_cmake_property(_variableNames VARIABLES)
#foreach (_variableName ${_variableNames})
#   message(STATUS "${_variableName}=${${_variableName}}")
#endforeach()
